<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
	http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
	
	<var name="ingredientCodeRecipeList" class="com.app.inv.model.IngredientCodeRecipeList"/>
	<var name="recipe" class="com.app.inv.model.Recipe"/>
	<var name="recipeService" class="com.app.inv.service.RecipeService"/>

	<view-state id="chooseMenuItem" model="menuItemList">
		<on-entry>
			<evaluate result="flowScope.menuItemList" expression="recipeService.loadMenuItemList()"/>
		</on-entry>
		<transition on="submitMenuItem" to="chooseIngredients"/>
        <transition on="cancel" to="cancel"/>
        <on-exit>
			<set name="flowScope.codeMenu" value = "requestParameters.code"/>
		</on-exit>
	</view-state>
	
	<view-state id="chooseIngredients" model="ingredientCodeRecipeList">
		<on-entry>
			<evaluate result="ingredientCodeRecipeList" expression="recipeService.loadIngredientCode(codeMenu)"/>
		</on-entry>
	    <transition on="submitIngredients" to="ingredientValues"/>
        <transition on="cancel" to="end"/>
    </view-state>
    
    <action-state id="forIngredientValue">
    	<evaluate result="recipe" expression="recipeService.forIngredientValue(ingredientCodeRecipeList, codeMenu)"/>
    	<transition to="ingredientValues"/>
    </action-state>
    
    <view-state id="ingredientValues" model="recipe" >
    	<on-entry>
    		<evaluate result="recipe" expression="recipeService.forIngredientValue(ingredientCodeRecipeList, codeMenu)"/>
    		<evaluate result="viewScope.unit" expression="recipeService.getUnits()"></evaluate>
    	</on-entry>
    	<transition on="submitValues" to="saveRecipe"/>
    	<transition on="cancel" to="end"/>
    </view-state>
    
    <action-state id="saveRecipe">
    	<evaluate expression="recipeService.saveRecipe(recipe)"></evaluate>
    	<transition to="success"/>
    </action-state>
    
    <view-state id="success">
    	<transition on="new" to="end"/>
    	<transition on="cancel" to="cancel"/>
    </view-state>
    
    <end-state id="cancel" view="externalRedirect:/maintenance/mi"/>
    
    <end-state id="end"/>
    
    <global-transitions>
		<transition on="cancel" to="cancel"/>
	</global-transitions>
 </flow>